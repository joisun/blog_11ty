---
layout: base.njk
---

<a class="cd-back" href="{{ '/' | url }}">
<pre>{{ site.back_home_text }}</pre>
</a>
{# data-pagefind-body 是搜索框架 pagefind用的 #}
<article class="prose" data-pagefind-body>
    <p class="post-meta">
        <time datetime="{{ page.date }}">{{ page.date | formatDate }}</time>
        , with
        <span id="busuanzi_container_page_pv" style="display: inline;"><span id="busuanzi_value_page_pv"></span></span>
        read
        <span>
            {# 输出预计阅读时间到页面 #}
            <span>, about {{ content | readingTime }}.</span>
        </span>
    </p>
    <h1>{{ title }}</h1>

    {% if tags %}
    <div class="post-tags">
        {% for tag in tags %}
        {% if tag != "post" and tag != "posts" %}
        <a href="/tags/?name={{ tag }}" class="post-tag">#{{ tag }}</a>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    {{ content | safe }}
</article>

{# giscus 评论系统 #}
<div id="giscus-container" class="giscus-container collapsed">
    <button
        id="giscus-toggle"
        class="giscus-toggle"
        title="Toggle Comments"
    >
        <div class="toggle-icon">
            <span class="toggle-text">COMMENTS</span>
        </div>
    </button>
    <div class="giscus-content">
        <div class="giscus-loading" id="giscus-loading">
            <div class="giscus-loading-spinner"></div>
            <span>loading comments...</span>
        </div>
        <script
            src="https://giscus.app/client.js"
            data-repo="joisun/blog_11ty"
            data-repo-id="R_kgDOK8mrlg"
            data-category="General"
            data-category-id="DIC_kwDOK8mrls4CcEYb"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="top"
            data-theme="noborder_light"
            data-lang="zh-CN"
            crossorigin="anonymous"
            async></script>
    </div>
    <div class="giscus-shortcuts">
        <kbd>C</kbd> <kbd>C</kbd> open · <kbd>ESC</kbd> close
    </div>
</div><aside>
    {{ content | toc | safe }}
</aside>
<a class="cd-back" href="{{ '/' | url }}">
<pre>{{ site.back_home_text }}</pre>
</a>
<script>
  const giscusContainer = document.querySelector('#giscus-container');
  const giscusToggle = document.querySelector('#giscus-toggle');

// 处理 C 键的双击监听
let lastCPressTime = 0;
const DOUBLE_CLICK_INTERVAL = 300; // 毫秒

  // 处理 按键监听事件 - START
  document.addEventListener("keyup", (e) => {
    if(e.key === "Escape"){
      if(!giscusContainer.classList.contains('collapsed')){
        giscusContainer.classList.add('collapsed');
        localStorage.setItem('giscus-collapsed', 'true');
        return;
      }
    }
    if(e.target.nodeName != "BODY") return
    if(e.key === "Escape"){
      handleGoToTop()
    }else if(e.key === "Backspace"){
      handleGoback()
    }else if(e.key === "C" || e.key === "c"){
      const currentTime = Date.now();
      const timeDiff = currentTime - lastCPressTime;
      if(timeDiff <= DOUBLE_CLICK_INTERVAL){
        // 双击 C 键
        handleGoToComment()
      }else{
        lastCPressTime = currentTime;
      }

    }
  });
   const handleGoToComment = ()=>{
    if (giscusContainer.classList.contains('collapsed')) {
      giscusContainer.classList.remove('collapsed');
      localStorage.setItem('giscus-collapsed', 'false');
    }
    // Optional: Focus or scroll inside giscus-content if needed
  }
  const handleGoToTop = ()=>{
    window.scrollTo(0,0)
  }
  // 处理 按键监听事件 - END

  // 处理 GO BACK 点击事件 - START
  const _HISTORY = localStorage.getItem('_HISTORY')
  const HISTORY = JSON.parse(_HISTORY)

  if(!_HISTORY){
    localStorage.setItem('_HISTORY', JSON.stringify([location.origin + location.pathname]))
  }else{
    const CURRENT_URL = location.origin + location.pathname
    if(HISTORY.at(-1) !== CURRENT_URL){
      HISTORY.push(CURRENT_URL)
      localStorage.setItem('_HISTORY', JSON.stringify(HISTORY))
    }
  }

  const handleGoback = ()=>{
    window.open(HISTORY.shift(),"_self")
  }

  // 处理 GO BACK 点击事件 - END

  // Giscus Loading 状态 - START
  window.addEventListener('message', (event) => {
    if (event.origin !== 'https://giscus.app') return;
    const loading = document.getElementById('giscus-loading');
    if (loading) loading.remove();
  });
  // Giscus Loading 状态 - END

  // Giscus 展开/收起逻辑 - START
  if (giscusToggle && giscusContainer) {
    giscusToggle.addEventListener('click', () => {
      giscusContainer.classList.toggle('collapsed');
      // 保存状态到 localStorage
      localStorage.setItem('giscus-collapsed', giscusContainer.classList.contains('collapsed'));
    });

    // 初始化状态
    const isCollapsed = localStorage.getItem('giscus-collapsed');
    if (isCollapsed === 'false') {
      giscusContainer.classList.remove('collapsed');
    }
  }
  // Giscus 展开/收起逻辑 - END

  // 图片点击的时候方法预览支持
  window.addEventListener("click", (e) => {
    if (e.target.nodeName === "IMG") {
      const w = 800
      const h = 400
      const windowFeatures = `width=${w},height=${h},left=${(window.innerWidth-w)/2},top=${(window.innerHeight-h)/2},directories=0,titlebar=0,toolbar=0,location=0,status=0,menubar=0,scrollbars=no,`;
      window.open(`/preview/?url=${e.target.src}`,'-',windowFeatures)
    }

  /*
    if (e.target.nodeName === "IMG") {
      console.dir(e.target.src)
      createPreviewPop(e.target.src)
    } else {
      document.querySelector("#img-preview") ?. remove()
    }
  */
  })
  function createPreviewPop(src) {
    let previewPop = document.querySelector("#img-preview")
    if (! previewPop) {
      previewPop = document.createElement("div")
      previewPop.id = 'img-preview';
      previewPop.style = `
         background-color: #fff;
         position:fixed;
         z-index: 2000;
         inset:0;
         display:flex;
         justify-content:center;
         align-items:center
         `
      previewPop.innerHTML = `
         <img src="${src}" style="object-fit: contain;width:100%;height:100%;pointer-events: none;"/>
         `
      document.body.appendChild(previewPop)
    }
    const img = previewPop.querySelector('img')
    img.src = src
  }

  // 优化阅读，当Heading 的数量过多的时候，在标题上显示一个小的 hx 以提示用户
  const headings = document.querySelectorAll('.prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6');
  const headings_l = headings.length;
  if(headings_l > 15){
    headings.forEach(el=>el.classList.add('show-heading'))
  }

  // TOC: hover 显示完整标题 + 滚动高亮 - START
  const tocLinks = document.querySelectorAll('.table-of-contents li a');
  tocLinks.forEach(link => { link.title = link.textContent.trim() });

  const tocHeadings = document.querySelectorAll('.prose h2[id], .prose h3[id], .prose h4[id]');
  if (tocHeadings.length && tocLinks.length) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector(`.table-of-contents li a[href="#${entry.target.id}"]`);
          if (activeLink) {
            activeLink.classList.add('active');
            activeLink.scrollIntoView({ block: 'center', behavior: 'smooth' });
          }
        }
      });
    }, { rootMargin: '0px 0px -70% 0px', threshold: 0 });
    tocHeadings.forEach(heading => observer.observe(heading));
  }
  // TOC: hover 显示完整标题 + 滚动高亮 - END
</script>
